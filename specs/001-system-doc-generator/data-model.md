# Data Model: Orisha

**Date**: 2026-01-31
**Branch**: `001-system-doc-generator`

## Entity Relationship Overview

```
┌─────────────────┐     ┌─────────────────────┐
│   Repository    │────▶│   AnalysisResult    │
└─────────────────┘     └─────────────────────┘
                                  │
                                  ▼
┌─────────────────┐     ┌─────────────────────┐     ┌─────────────────┐
│ LLMConfig│────▶│  OutputDocument     │◀────│ HumanOverrides  │
└─────────────────┘     └─────────────────────┘     └─────────────────┘
                                  ▲
┌─────────────────┐               │
│ DocTemplate     │───────────────┘
└─────────────────┘

┌─────────────────┐     ┌─────────────────────┐
│  ToolRegistry   │────▶│   ToolAdapter       │
└─────────────────┘     └─────────────────────┘
```

---

## Entities

### Repository

The source git repository being analyzed; contains source files, infrastructure code, and dependency manifests.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| path | `Path` | Yes | Absolute path to repository root |
| git_ref | `str \| None` | No | Current git commit SHA or branch name |
| name | `str` | Yes | Repository name (derived from path or git remote) |
| detected_languages | `list[str]` | Yes | Languages detected via file extensions and parsing |

**Validation Rules:**
- `path` must exist and be a directory
- `path` must contain a `.git` directory (warning if not a git repo)
- `detected_languages` populated from file extension scanning

---

### AnalysisResult

Structured data collected from deterministic analysis tools (AST parsing, Syft, dependency parsing); serves as input to template rendering.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| repository | `Repository` | Yes | Source repository reference |
| timestamp | `datetime` | Yes | Analysis execution timestamp (UTC) |
| technology_stack | `TechnologyStack` | Yes | Detected languages, frameworks, dependencies |
| sbom | `SBOM \| None` | No | Syft-generated Software Bill of Materials |
| architecture_diagram | `ArchitectureDiagram \| None` | No | Terravision-generated diagram |
| source_analysis | `SourceAnalysis` | Yes | AST-derived code structure information |
| errors | `list[AnalysisError]` | Yes | Non-fatal errors encountered during analysis |

**State Transitions:**
- `pending` → `running` → `completed` | `failed`

---

### TechnologyStack

Inventory of detected languages, frameworks, and dependencies; derived from dependency files and Syft scanning.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| languages | `list[LanguageInfo]` | Yes | Detected programming languages with versions |
| frameworks | `list[Framework]` | Yes | Detected frameworks (e.g., FastAPI, React) |
| dependencies | `list[Dependency]` | Yes | Third-party dependencies with versions |
| dev_dependencies | `list[Dependency]` | Yes | Development-only dependencies |

**Derived From:**
- `package.json` → JavaScript/TypeScript dependencies
- `requirements.txt` / `pyproject.toml` → Python dependencies
- `go.mod` → Go dependencies
- `pom.xml` / `build.gradle` → Java dependencies

---

### Dependency

A single third-party dependency with version information.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Package name |
| version | `str \| None` | No | Version specifier (may be range or exact) |
| source_file | `str` | Yes | File where dependency was declared |
| ecosystem | `str` | Yes | Package ecosystem (npm, pypi, go, maven) |
| license | `str \| None` | No | License identifier if available from SBOM |

---

### SBOM

Software Bill of Materials generated by Syft.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| format | `str` | Yes | SBOM format (syft-json, cyclonedx, spdx) |
| packages | `list[SBOMPackage]` | Yes | All detected packages |
| source | `str` | Yes | Syft version and scan target |
| generated_at | `datetime` | Yes | SBOM generation timestamp |

---

### ArchitectureDiagram

Visual representation of cloud infrastructure generated from Terraform; embedded as image in final documentation.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| image_path | `Path` | Yes | Path to generated PNG/SVG file |
| format | `str` | Yes | Image format (png, svg) |
| source_files | `list[str]` | Yes | Terraform files used to generate diagram |
| cloud_provider | `str \| None` | No | Detected cloud provider (aws, gcp, azure) |
| generation_tool | `str` | Yes | Tool used (terravision) |

---

### SourceAnalysis

AST-derived information about code structure.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| modules | `list[ModuleInfo]` | Yes | Detected modules/packages |
| entry_points | `list[EntryPoint]` | Yes | Main functions, CLI commands, API endpoints |
| classes | `list[ClassInfo]` | Yes | Class definitions with methods |
| functions | `list[FunctionInfo]` | Yes | Top-level functions |
| parsing_errors | `list[ParsingError]` | Yes | Files that failed to parse |

---

### LLMConfig

Settings specifying which LLM backend to use and connection parameters.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| provider | `str` | Yes | LLM provider (claude, gemini, ollama, bedrock) |
| model | `str` | Yes | Model identifier |
| api_key | `str \| None` | No | API key (not required for Ollama) |
| api_base | `str \| None` | No | API base URL (required for Ollama) |
| temperature | `float` | Yes | Temperature setting (default: 0) |
| max_tokens | `int` | Yes | Maximum response tokens |
| enabled | `bool` | Yes | Whether LLM summarization is enabled |

**Validation Rules:**
- `provider` must be one of: claude, gemini, ollama, bedrock
- `temperature` must be 0 for reproducibility (FR-012)
- `api_key` required for claude and gemini
- `api_base` required for ollama (defaults to http://localhost:11434)

---

### DocumentationTemplate

A Jinja2 template defining the structure and sections of the output document.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| path | `Path` | Yes | Path to template file |
| name | `str` | Yes | Template identifier |
| format | `str` | Yes | Output format (markdown, html, confluence) |
| placeholders | `list[str]` | Yes | Available placeholder variables |
| custom_sections | `dict[str, str]` | No | User-defined content for specific sections |

**Validation Rules:**
- `path` must exist and be readable
- Template must be valid Jinja2 syntax

---

### OutputDocument

The final rendered documentation in the specified format.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| content | `str` | Yes | Rendered document content |
| format | `str` | Yes | Output format (markdown, html, confluence) |
| generated_at | `datetime` | Yes | Generation timestamp (UTC) |
| version_history | `list[VersionEntry]` | Yes | Document version history (SC-011) |
| source_repository | `str` | Yes | Git remote URL or path |
| source_commit | `str \| None` | No | Git commit SHA at generation time |
| embedded_assets | `list[Path]` | Yes | Paths to embedded images (diagrams) |
| llm_sections | `list[str]` | Yes | Sections generated by LLM |
| deterministic_sections | `list[str]` | Yes | Sections generated deterministically |

---

### VersionEntry

A single entry in the document version history (SC-011).

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| version | `str` | Yes | Version identifier |
| timestamp | `datetime` | Yes | Change timestamp (UTC) |
| author | `str` | Yes | Author: "Orisha" or human name |
| author_type | `str` | Yes | Type: "automated" or "human" |
| changes | `str` | Yes | Summary of changes |
| git_ref | `str \| None` | No | Git commit SHA for this version |

---

### AnalysisError

Non-fatal error encountered during analysis.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| component | `str` | Yes | Component that failed (syft, terravision, ast) |
| message | `str` | Yes | Error description |
| file_path | `str \| None` | No | File that caused the error |
| recoverable | `bool` | Yes | Whether analysis continued |

---

## Canonical Data Formats (Principle V: Tool Agnosticism)

These are the **standard internal formats** that all tool adapters MUST produce. The rest of Orisha only works with these canonical formats, never with tool-specific output. This enables true tool swappability.

### CanonicalSBOM

Standard SBOM format produced by all SBOM tool adapters (Syft, Trivy, etc.).

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| packages | `list[CanonicalPackage]` | Yes | All detected packages |
| source | `SBOMSource` | Yes | Metadata about the scan |

### CanonicalPackage

Standard package representation across all SBOM tools.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Package name |
| version | `str \| None` | No | Version string |
| ecosystem | `str` | Yes | Package ecosystem: `npm`, `pypi`, `go`, `maven`, `cargo`, etc. |
| license | `str \| None` | No | SPDX license identifier |
| source_file | `str \| None` | No | File where dependency was declared |
| purl | `str \| None` | No | Package URL (standardized identifier) |

### SBOMSource

Metadata about the SBOM generation.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| tool | `str` | Yes | Tool that generated this (e.g., "syft", "trivy") |
| tool_version | `str` | Yes | Version of the tool |
| scanned_at | `datetime` | Yes | When the scan was performed |
| target | `str` | Yes | What was scanned (path or image name) |

---

### CanonicalArchitecture

Standard architecture format produced by all diagram/infrastructure tool adapters. Uses a hybrid format: adjacency list for connections (matching Terravision's native output) plus node metadata dict.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| graph | `CanonicalGraph` | Yes | The architecture topology |
| rendered_image | `RenderedImage \| None` | No | Optional pre-rendered PNG/SVG |
| source | `ArchitectureSource` | Yes | Metadata about generation |

### CanonicalGraph

Hybrid graph structure: adjacency list for connections, dict for node metadata.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| nodes | `dict[str, NodeMetadata]` | Yes | Node ID → metadata mapping |
| connections | `dict[str, list[str]]` | Yes | Node ID → list of connected node IDs (adjacency list) |
| cloud_providers | `list[str]` | Yes | Providers present: `aws`, `gcp`, `azure` |

**Example:**
```python
{
    "nodes": {
        "aws_s3_bucket.data": {"type": "aws_s3_bucket", "provider": "aws", "name": "data-bucket"},
        "aws_lambda_function.processor": {"type": "aws_lambda_function", "provider": "aws"}
    },
    "connections": {
        "aws_s3_bucket.data": ["aws_lambda_function.processor"],
        "aws_lambda_function.processor": ["aws_dynamodb_table.results"]
    },
    "cloud_providers": ["aws"]
}
```

### NodeMetadata

Metadata for a single node in the architecture graph.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| type | `str` | Yes | Resource type (e.g., `aws_s3_bucket`, `google_compute_instance`) |
| provider | `str` | Yes | Cloud provider: `aws`, `gcp`, `azure` |
| name | `str \| None` | No | Human-readable name |
| attributes | `dict[str, Any] \| None` | No | Key properties (region, size, etc.) |

### RenderedImage

Optional pre-rendered visualization of the architecture.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| data | `bytes \| None` | No | Embedded image data |
| path | `Path \| None` | No | Path to image file |
| format | `str` | Yes | Image format: `png`, `svg` |

### ArchitectureSource

Metadata about how the architecture was extracted.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| tool | `str` | Yes | Tool that generated this (e.g., "terravision") |
| tool_version | `str` | Yes | Version of the tool |
| generated_at | `datetime` | Yes | When the graph was generated |
| source_files | `list[str]` | Yes | Infrastructure files used (Terraform, CloudFormation, etc.) |
| source_type | `str` | Yes | Source format: `terraform`, `cloudformation`, `pulumi`, `manual` |

---

### CanonicalAST

Standard AST analysis format produced by all AST tool adapters.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| modules | `list[CanonicalModule]` | Yes | Detected modules/packages |
| entry_points | `list[CanonicalEntryPoint]` | Yes | Main functions, CLI commands |
| classes | `list[CanonicalClass]` | Yes | Class definitions |
| functions | `list[CanonicalFunction]` | Yes | Top-level functions |
| source | `ASTSource` | Yes | Metadata about parsing |

### CanonicalModule

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Module/package name |
| path | `str` | Yes | File path |
| language | `str` | Yes | Programming language |
| imports | `list[str]` | Yes | Import statements |

### CanonicalClass

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Class name |
| file | `str` | Yes | File path |
| line | `int` | Yes | Line number |
| methods | `list[str]` | Yes | Method names |
| bases | `list[str]` | Yes | Base classes |
| docstring | `str \| None` | No | Extracted class docstring |
| description | `str \| None` | No | LLM-generated explanation of class responsibility |

**New Fields (Phase 5 - Code Explanation)**:
- `docstring`: Extracted deterministically from source
- `description`: Generated by LLM from docstring + class structure

### CanonicalFunction

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Function name |
| file | `str` | Yes | File path |
| line | `int` | Yes | Line number |
| parameters | `list[str]` | Yes | Parameter names |
| is_async | `bool` | Yes | Whether function is async |
| docstring | `str \| None` | No | Extracted docstring/JSDoc/Go comment |
| return_type | `str \| None` | No | Return type annotation if available |
| source_snippet | `str \| None` | No | First N lines of function body (for LLM context) |
| description | `str \| None` | No | LLM-generated explanation of function behavior |

**New Fields (Phase 5 - Code Explanation)**:
- `docstring`: Extracted deterministically from source using tree-sitter node types
- `return_type`: Extracted from type annotations where available
- `source_snippet`: First 5 lines of function body, truncated for token budget
- `description`: Generated by LLM from docstring + snippet + name

### CanonicalEntryPoint

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Entry point name |
| type | `str` | Yes | Type: `main`, `cli_command`, `api_endpoint`, `handler` |
| file | `str` | Yes | File path |
| line | `int` | Yes | Line number |

### ASTSource

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| tool | `str` | Yes | Parser used (e.g., "tree-sitter") |
| languages | `list[str]` | Yes | Languages parsed |
| files_parsed | `int` | Yes | Number of files successfully parsed |
| files_failed | `int` | Yes | Number of files that failed to parse |
| parsed_at | `datetime` | Yes | When parsing was performed |

---

## Flow-Based Documentation Models (Phase 4e)

These models support the flow-based documentation approach where Code Structure shows module-level summaries, system flow diagrams, and entry points rather than function-by-function explanations.

### CanonicalModule

Represents a detected code module/package for flow-based documentation.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Module name (e.g., "analyzers", "llm") |
| path | `str` | Yes | Relative path from repo root |
| files | `list[str]` | Yes | Files contained in this module |
| classes | `list[str]` | Yes | Class names in this module |
| functions | `list[str]` | Yes | Top-level function names in this module |
| imports | `list[str]` | Yes | Internal modules this module imports |
| language | `str` | Yes | Primary language of the module |

### ModuleSummary

Module with LLM-generated responsibility summary for documentation output.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Module name |
| path | `str` | Yes | Relative path from repo root |
| responsibility | `str` | Yes | LLM-generated 1-2 sentence summary of what this module does |
| key_classes | `list[str]` | Yes | Most important classes in the module (max 5) |
| key_functions | `list[str]` | Yes | Most important functions in the module (max 5) |
| file_count | `int` | Yes | Number of files in the module |

### EntryPoint

Represents a public entry point (CLI command, API endpoint, handler).

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Entry point name (e.g., "write", "/api/users") |
| type | `str` | Yes | Type: `cli_command`, `api_endpoint`, `handler`, `main` |
| file | `str` | Yes | Source file path |
| line | `int` | Yes | Line number |
| description | `str \| None` | No | Extracted docstring or annotation description |
| method | `str \| None` | No | HTTP method for API endpoints (GET, POST, etc.) |

### ExternalIntegration

Represents a detected external service integration.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Service/library name (e.g., "PostgreSQL", "Redis") |
| type | `str` | Yes | Type: `database`, `http`, `queue`, `cache`, `storage` |
| library | `str` | Yes | Library used (e.g., "sqlalchemy", "requests", "boto3") |
| locations | `list[str]` | Yes | Files where this integration is used |

### ImportGraph

Directed graph of module import relationships for flow diagram generation.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| nodes | `list[str]` | Yes | Module names |
| edges | `list[tuple[str, str]]` | Yes | (importing_module, imported_module) pairs |

### ModuleFlowDiagram

Generated Mermaid diagram showing module relationships.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| mermaid | `str` | Yes | Mermaid flowchart syntax |
| node_count | `int` | Yes | Number of nodes in diagram |
| simplified | `bool` | Yes | Whether sub-modules were grouped to reduce complexity |
| title | `str` | Yes | Diagram title |

---

## Tool Adapter Pattern

### ToolAdapter (Principle V: Tool Agnosticism)

Abstract interface for pluggable analysis tools. Each adapter transforms tool-specific output to canonical format.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Tool identifier (e.g., "syft", "trivy") |
| capability | `str` | Yes | Capability type (sbom, diagram, ast) |
| version | `str \| None` | No | Tool version if available |

**Interface Methods:**
- `check_available() -> bool` - Verify tool is installed and accessible
- `get_version() -> str | None` - Return tool version string
- `execute(input: Path) -> CanonicalFormat` - Run tool and return **canonical format**

**Adapter Responsibilities:**
1. Invoke the external tool with appropriate arguments
2. Parse tool-specific output (JSON, text, etc.)
3. Transform to canonical format (CanonicalSBOM, CanonicalDiagram, etc.)
4. Handle tool-specific errors gracefully

**Example: Syft Adapter**
```
Syft JSON output → SyftAdapter.execute() → CanonicalSBOM
```

**Example: Trivy Adapter**
```
Trivy JSON output → TrivyAdapter.execute() → CanonicalSBOM (same format!)
```

---

### ToolRegistry (Principle V: Tool Agnosticism)

Registry of available tool adapters for each capability.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| sbom_adapters | `dict[str, SBOMAdapter]` | Yes | Registered SBOM adapters |
| diagram_adapters | `dict[str, DiagramAdapter]` | Yes | Registered diagram adapters |
| ast_adapters | `dict[str, ASTAdapter]` | Yes | Registered AST adapters |

**Configuration:**
```yaml
tools:
  sbom: syft          # → uses SyftAdapter → outputs CanonicalSBOM
  diagrams: terravision  # → uses TerravisionAdapter → outputs CanonicalDiagram
```

**Adding a New Tool:**
1. Implement the appropriate adapter interface (e.g., `SBOMAdapter`)
2. Transform tool output to canonical format
3. Register in ToolRegistry
4. No changes needed to rest of codebase

---

### SectionConfig (Principle VI: Human Annotation Persistence)

Configuration for a human-authored section that merges with generated content.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| section_id | `str` | Yes | Section identifier (e.g., "overview", "security") |
| file | `Path` | Yes | Path to markdown file with human content |
| strategy | `str` | Yes | How to merge: "replace", "prepend", "append" |

**Merge Strategies:**
- `replace`: Human content replaces generated content entirely
- `prepend`: Human content appears before generated content
- `append`: Human content appears after generated content

**Configuration Example:**
```yaml
sections:
  overview:
    file: ".orisha/sections/overview.md"
    strategy: "prepend"
  security:
    file: ".orisha/sections/security.md"
    strategy: "append"
```

**File Structure:**
```
.orisha/
├── config.yaml
└── sections/
    ├── overview.md
    └── security.md
```

---

## Configuration Schema

### OrishaConfig

Top-level configuration loaded from YAML file. CLI provides only per-run overrides (`--output`, `--format`, `--ci`).

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| output | `OutputConfig` | Yes | - | Output path and format |
| template | `TemplateConfig \| None` | No | None | Custom template settings |
| tools | `ToolConfig` | No | defaults | Tool selection (Principle V) |
| sections | `dict[str, SectionConfig]` | No | `{}` | Human content sections (Principle VI) |
| llm | `LLMConfig \| None` | No | None | LLM settings |
| ci | `CIConfig` | No | defaults | CI/CD settings |

---

### ToolConfig (Principle V: Tool Agnosticism)

Tool selection configuration. Tools are auto-skipped if not applicable (no dependency files, no Terraform).

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| sbom | `str` | No | `syft` | SBOM tool: syft, trivy |
| diagrams | `str` | No | `terravision` | Diagram tool: terravision |

**Configuration File Locations** (in priority order):
1. CLI `--config` argument
2. `./.orisha/config.yaml`
3. `./orisha.yaml`

---

## Extended Canonical Formats

These additional canonical formats support the expanded template structure (see contracts/template.md).

### CanonicalInfrastructure

Categorized infrastructure resources from Terraform analysis.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| available | `bool` | Yes | Whether Terraform was detected |
| compute | `list[InfraResource]` | Yes | Compute resources (EC2, Lambda, ECS) |
| storage | `list[InfraResource]` | Yes | Storage resources (S3, RDS, DynamoDB) |
| networking | `list[InfraResource]` | Yes | Network resources (VPC, subnets, LBs) |
| services | `list[CloudService]` | Yes | Managed cloud services |
| source | `InfrastructureSource` | Yes | Metadata about parsing |

### InfraResource

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Resource name |
| type | `str` | Yes | Terraform resource type |
| provider | `str` | Yes | Cloud provider (aws, gcp, azure) |
| config_summary | `str` | Yes | Human-readable configuration summary |
| attributes | `dict[str, Any]` | No | Key configuration attributes |

### CloudService

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Service name |
| provider | `str` | Yes | Cloud provider |
| type | `str` | Yes | Service category (queue, notification, monitoring) |
| purpose | `str` | Yes | Inferred purpose |

### InfrastructureSource

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| tool | `str` | Yes | Parser used (e.g., "hcl2-parser", "terravision") |
| terraform_version | `str \| None` | No | Terraform version if detected |
| files_parsed | `list[str]` | Yes | Terraform files analyzed |
| parsed_at | `datetime` | Yes | When parsing was performed |

---

### CanonicalData

Data models and stores detected from ORM/schema analysis.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| models | `list[DataModel]` | Yes | Detected ORM/entity models |
| stores | `list[DataStore]` | Yes | Detected data stores |
| source | `DataAnalysisSource` | Yes | Metadata about detection |

### DataModel

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Model/entity class name |
| table_name | `str \| None` | No | Database table name if specified |
| file | `str` | Yes | Source file path |
| line | `int` | Yes | Line number |
| orm_type | `str` | Yes | ORM type (sqlalchemy, django, prisma, typeorm) |
| fields | `list[DataField]` | Yes | Field definitions |

### DataField

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Field name |
| type | `str` | Yes | Data type |
| constraints | `list[str]` | Yes | Constraints (primary_key, unique, nullable, etc.) |
| foreign_key | `str \| None` | No | Foreign key reference if applicable |

### DataStore

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Store identifier |
| type | `str` | Yes | Store type (postgresql, mysql, redis, dynamodb) |
| location | `str` | Yes | Where detected (config, terraform, code) |
| purpose | `str` | Yes | Inferred purpose |

### DataAnalysisSource

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| orm_types_detected | `list[str]` | Yes | ORM frameworks found |
| schema_files | `list[str]` | Yes | Schema files analyzed |
| analyzed_at | `datetime` | Yes | When analysis was performed |

---

### CanonicalSecurity

Security patterns and configurations detected from code and Terraform.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| iam | `list[IAMResource]` | Yes | IAM policies and roles |
| auth_patterns | `list[AuthPattern]` | Yes | Authentication patterns detected |
| secrets_management | `list[SecretPattern]` | Yes | Secret management patterns |
| network_security | `list[NetworkSecurityRule]` | Yes | Security groups, firewall rules |
| source | `SecurityAnalysisSource` | Yes | Metadata about detection |

### IAMResource

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Resource name |
| type | `str` | Yes | Resource type (role, policy, user, group) |
| provider | `str` | Yes | Cloud provider |
| permissions_summary | `str` | Yes | Human-readable permissions summary |
| attached_to | `list[str]` | No | Resources this is attached to |

### AuthPattern

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| type | `str` | Yes | Pattern type (jwt, oauth, session, api_key, basic) |
| description | `str` | Yes | Description of implementation |
| location | `str` | Yes | File path |
| library | `str \| None` | No | Library used if detected |

### SecretPattern

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| pattern | `str` | Yes | Pattern name (env_var, secrets_manager, vault, kms) |
| location | `str` | Yes | Where detected |
| notes | `str` | Yes | Additional context |

### NetworkSecurityRule

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| resource | `str` | Yes | Security group/firewall name |
| direction | `str` | Yes | ingress or egress |
| protocol | `str` | Yes | Protocol (tcp, udp, all) |
| port_range | `str` | Yes | Port range |
| source | `str` | Yes | Source CIDR or security group |
| description | `str \| None` | No | Rule description |

### SecurityAnalysisSource

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| terraform_files | `list[str]` | Yes | Terraform files analyzed |
| code_files | `list[str]` | Yes | Code files analyzed |
| analyzed_at | `datetime` | Yes | When analysis was performed |

---

### CanonicalResilience

Resilience and operational patterns detected from infrastructure and code.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| scalability | `list[ScalingConfig]` | Yes | Auto-scaling configurations |
| high_availability | `list[HAFeature]` | Yes | HA features detected |
| observability | `list[ObservabilityTool]` | Yes | Monitoring/logging tools |
| source | `ResilienceAnalysisSource` | Yes | Metadata about detection |

### ScalingConfig

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| resource | `str` | Yes | Resource being scaled |
| type | `str` | Yes | Scaling type (horizontal, vertical, auto) |
| config | `str` | Yes | Configuration summary |
| min_capacity | `int \| None` | No | Minimum capacity |
| max_capacity | `int \| None` | No | Maximum capacity |

### HAFeature

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| feature | `str` | Yes | HA feature name |
| config | `str` | Yes | Configuration summary |
| notes | `str` | Yes | Additional context |

### ObservabilityTool

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| tool | `str` | Yes | Tool name (prometheus, datadog, cloudwatch) |
| type | `str` | Yes | Type (metrics, logging, tracing, apm) |
| integration | `str` | Yes | How it's integrated |

### ResilienceAnalysisSource

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| terraform_files | `list[str]` | Yes | Terraform files analyzed |
| dependency_files | `list[str]` | Yes | Dependency files analyzed |
| code_patterns | `list[str]` | Yes | Code patterns detected |
| analyzed_at | `datetime` | Yes | When analysis was performed |

---

### MermaidDiagram

Mermaid diagram generated from code analysis.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| available | `bool` | Yes | Whether diagram was generated |
| type | `str` | Yes | Diagram type (flowchart, classDiagram, graph) |
| mermaid | `str` | Yes | Mermaid diagram source code |
| title | `str \| None` | No | Diagram title |
| source | `MermaidSource` | Yes | Metadata about generation |

### MermaidSource

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| generator | `str` | Yes | Generator used (ast-to-mermaid) |
| input_type | `str` | Yes | Input type (module_graph, class_hierarchy, connectivity) |
| files_analyzed | `int` | Yes | Number of files analyzed |
| generated_at | `datetime` | Yes | When diagram was generated |

---

### CanonicalAPI

API endpoints and schemas detected from code analysis.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| endpoints | `list[APIEndpoint]` | Yes | REST API endpoints |
| graphql | `GraphQLSchema \| None` | No | GraphQL schema if detected |
| grpc | `GRPCSchema \| None` | No | gRPC services if detected |
| openapi_spec | `str \| None` | No | Path to OpenAPI/Swagger spec if found |
| source | `APIAnalysisSource` | Yes | Metadata about detection |

### APIEndpoint

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| method | `str` | Yes | HTTP method (GET, POST, PUT, DELETE, PATCH) |
| path | `str` | Yes | URL path pattern |
| handler | `str` | Yes | Handler function/method name |
| file | `str` | Yes | Source file path |
| line | `int` | Yes | Line number |
| description | `str \| None` | No | Docstring or annotation description |
| parameters | `list[APIParameter]` | Yes | Path, query, header parameters |
| request_body | `RequestBody \| None` | No | Request body schema |
| responses | `list[APIResponse]` | Yes | Response definitions |

### APIParameter

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Parameter name |
| location | `str` | Yes | Parameter location (path, query, header, cookie) |
| type | `str` | Yes | Data type |
| required | `bool` | Yes | Whether parameter is required |
| description | `str \| None` | No | Parameter description |

### RequestBody

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| content_type | `str` | Yes | Content type (application/json, etc.) |
| schema | `dict[str, Any]` | Yes | Schema definition |
| required | `bool` | Yes | Whether body is required |

### APIResponse

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| status | `int` | Yes | HTTP status code |
| description | `str` | Yes | Response description |
| content_type | `str \| None` | No | Response content type |

### GraphQLSchema

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| endpoint | `str` | Yes | GraphQL endpoint path |
| queries | `list[GraphQLOperation]` | Yes | Query definitions |
| mutations | `list[GraphQLOperation]` | Yes | Mutation definitions |
| subscriptions | `list[GraphQLOperation]` | Yes | Subscription definitions |

### GraphQLOperation

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Operation name |
| args | `list[str]` | Yes | Argument definitions |
| return_type | `str` | Yes | Return type |

### GRPCSchema

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| services | `list[GRPCService]` | Yes | gRPC service definitions |
| proto_files | `list[str]` | Yes | Proto file paths |

### GRPCService

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Service name |
| methods | `list[GRPCMethod]` | Yes | Service methods |

### GRPCMethod

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Method name |
| request | `str` | Yes | Request message type |
| response | `str` | Yes | Response message type |
| streaming | `str` | Yes | Streaming type (none, client, server, bidirectional) |

### APIAnalysisSource

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| frameworks_detected | `list[str]` | Yes | Frameworks found (fastapi, flask, express, etc.) |
| files_analyzed | `list[str]` | Yes | Files analyzed for endpoints |
| analyzed_at | `datetime` | Yes | When analysis was performed |

---

### CanonicalBuild

Build, containerization, and CI/CD configuration detected from project files.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| containerization | `list[ContainerConfig]` | Yes | Container configurations |
| ci_pipelines | `list[CIPipeline]` | Yes | CI/CD pipeline definitions |
| scripts | `list[BuildScript]` | Yes | Build scripts detected |
| package_managers | `list[PackageManager]` | Yes | Package manager configurations |
| source | `BuildAnalysisSource` | Yes | Metadata about detection |

### ContainerConfig

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| file | `str` | Yes | Dockerfile or compose file path |
| type | `str` | Yes | Type (dockerfile, docker-compose) |
| base_image | `str \| None` | No | Base image if Dockerfile |
| stages | `list[str]` | No | Multi-stage build stages |
| ports | `list[int]` | Yes | Exposed ports |
| entrypoint | `str \| None` | No | Entry point command |

### CIPipeline

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| platform | `str` | Yes | CI platform (github_actions, gitlab, jenkins, etc.) |
| file | `str` | Yes | Configuration file path |
| stages | `list[CIStage]` | Yes | Pipeline stages |
| triggers | `list[str]` | Yes | Trigger events |

### CIStage

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Stage name |
| jobs | `list[str]` | Yes | Jobs in this stage |

### BuildScript

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Script name or file |
| purpose | `str` | Yes | Inferred purpose |
| command | `str` | Yes | Command or script content |
| file | `str` | Yes | Source file |

### PackageManager

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Package manager name (npm, pip, go, maven, etc.) |
| config_file | `str` | Yes | Configuration file path |
| scripts | `list[str]` | No | Defined scripts (npm scripts, etc.) |

### BuildAnalysisSource

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| files_analyzed | `list[str]` | Yes | Build/CI files analyzed |
| analyzed_at | `datetime` | Yes | When analysis was performed |

---

### CanonicalTesting

Testing configuration and test file analysis.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| summary | `TestSummary` | Yes | Aggregate statistics |
| frameworks | `list[TestFramework]` | Yes | Detected testing frameworks |
| test_structure | `list[TestCategory]` | Yes | Tests by category |
| coverage | `CoverageConfig \| None` | No | Coverage configuration |
| fixtures | `list[TestFixture]` | Yes | Test fixtures and utilities |
| source | `TestAnalysisSource` | Yes | Metadata about detection |

### TestSummary

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| test_files | `int` | Yes | Total test files |
| test_functions | `int` | Yes | Total test functions |
| test_classes | `int` | Yes | Total test classes |
| frameworks | `list[str]` | Yes | Frameworks detected |

### TestFramework

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Framework name |
| language | `str` | Yes | Programming language |
| config_file | `str \| None` | No | Configuration file if found |
| pattern | `str` | Yes | Test file pattern |

### TestCategory

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| type | `str` | Yes | Category type (unit, integration, e2e, performance) |
| files | `list[TestFile]` | Yes | Test files in category |

### TestFile

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| path | `str` | Yes | File path |
| test_count | `int` | Yes | Number of tests in file |
| description | `str` | Yes | Inferred description |

### CoverageConfig

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| tool | `str` | Yes | Coverage tool (coverage.py, istanbul, etc.) |
| config_file | `str` | Yes | Configuration file path |
| thresholds | `CoverageThresholds \| None` | No | Coverage thresholds if configured |

### CoverageThresholds

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| line | `float` | Yes | Line coverage threshold percentage |
| branch | `float` | Yes | Branch coverage threshold percentage |

### TestFixture

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| type | `str` | Yes | Fixture type (conftest, factory, mock, etc.) |
| location | `str` | Yes | File path |
| purpose | `str` | Yes | Inferred purpose |

### TestAnalysisSource

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| files_analyzed | `list[str]` | Yes | Test files analyzed |
| config_files | `list[str]` | Yes | Test config files found |
| analyzed_at | `datetime` | Yes | When analysis was performed |

---

### CanonicalLogging

Logging and error handling patterns detected from code analysis.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| libraries | `list[LoggingLibrary]` | Yes | Logging libraries detected |
| patterns | `list[LogPattern]` | Yes | Logging patterns found |
| log_levels | `list[LogLevelUsage]` | Yes | Log level usage statistics |
| error_handling | `ErrorHandlingPatterns` | Yes | Error handling patterns |
| source | `LoggingAnalysisSource` | Yes | Metadata about detection |

### LoggingLibrary

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Library name |
| language | `str` | Yes | Programming language |
| config_file | `str \| None` | No | Configuration file if found |

### LogPattern

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| type | `str` | Yes | Pattern type (structured, unstructured, json) |
| file_count | `int` | Yes | Files using this pattern |
| example | `str` | Yes | Example log statement |

### LogLevelUsage

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Log level name (debug, info, warning, error, critical) |
| count | `int` | Yes | Number of occurrences |
| usage | `str` | Yes | Primary usage context |

### ErrorHandlingPatterns

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| patterns | `list[ErrorPattern]` | Yes | Error handling patterns |
| custom_exceptions | `list[CustomException]` | Yes | Custom exception classes |
| error_boundaries | `list[ErrorBoundary]` | Yes | React error boundaries |

### ErrorPattern

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| type | `str` | Yes | Pattern type (try-catch, result-type, error-middleware) |
| language | `str` | Yes | Programming language |
| count | `int` | Yes | Number of occurrences |

### CustomException

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Exception class name |
| file | `str` | Yes | Source file path |
| purpose | `str` | Yes | Inferred purpose |

### ErrorBoundary

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Component name |
| file | `str` | Yes | Source file path |
| fallback | `str` | Yes | Fallback behavior |

### LoggingAnalysisSource

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| files_analyzed | `list[str]` | Yes | Code files analyzed |
| patterns_detected | `list[str]` | Yes | Pattern types found |
| analyzed_at | `datetime` | Yes | When analysis was performed |

---

## Data Flow Analysis

### CanonicalDataFlow

Root container for data flow analysis results including entry points, call chains, and generated diagrams.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| entry_points | `list[EntryPointFlow]` | Yes | API endpoints, handlers, main functions |
| call_chains | `list[CallChain]` | Yes | Function call sequences from entry points |
| external_services | `list[ExternalServiceCall]` | Yes | HTTP, database, queue, cache calls |
| diagrams | `list[MermaidDiagram]` | Yes | Generated Mermaid diagrams |
| source | `DataFlowAnalysisSource` | Yes | Analysis metadata |

### EntryPointFlow

Represents a system entry point (API endpoint, handler, main function).

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Function/handler name |
| type | `str` | Yes | Type: `api_endpoint`, `handler`, `main`, `cli_command` |
| framework | `str \| None` | No | Framework: `fastapi`, `flask`, `express`, `django`, etc |
| path | `str \| None` | No | URL path for API endpoints |
| method | `str \| None` | No | HTTP method (GET, POST, etc) |
| file | `str` | Yes | Source file path |
| line | `int` | Yes | Line number |

### CallChain

Represents a sequence of function calls from an entry point.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| entry_point | `str` | Yes | Entry point function name |
| chain | `list[str]` | Yes | Ordered list of called functions |
| external_calls | `list[ExternalServiceCall]` | Yes | External service calls in this chain |
| depth | `int` | Yes | Maximum call depth |

### ExternalServiceCall

Represents a call to an external service (HTTP, database, queue, cache).

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| call_site | `str` | Yes | Function making the call |
| service_type | `str` | Yes | Type: `http`, `database`, `queue`, `cache` |
| service_name | `str` | Yes | Library/service name (requests, sqlalchemy, boto3) |
| file | `str` | Yes | Source file path |
| line | `int` | Yes | Line number |
| details | `dict` | No | Additional details (URL pattern, DB type, etc) |

### MermaidDiagram

Generated Mermaid diagram for visualization.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| diagram_type | `str` | Yes | Type: `sequence`, `flowchart`, `graph` |
| title | `str` | Yes | Diagram title |
| content | `str` | Yes | Mermaid syntax content |
| node_count | `int` | Yes | Number of nodes in diagram |
| source_entry_points | `list[str]` | Yes | Entry points included in this diagram |

### DataFlowAnalysisSource

Metadata about the data flow analysis.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| files_analyzed | `list[str]` | Yes | Source files analyzed |
| frameworks_detected | `list[str]` | Yes | Web frameworks detected |
| entry_point_count | `int` | Yes | Number of entry points found |
| external_call_count | `int` | Yes | Number of external service calls |
| analyzed_at | `datetime` | Yes | When analysis was performed |

---

## Extended AnalysisResult

The AnalysisResult entity is extended to include the new canonical formats:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| ... | ... | ... | *(existing fields)* |
| infrastructure | `CanonicalInfrastructure \| None` | No | Terraform resource analysis |
| data | `CanonicalData \| None` | No | ORM/schema analysis |
| security | `CanonicalSecurity \| None` | No | Security pattern analysis |
| resilience | `CanonicalResilience \| None` | No | Resilience pattern analysis |
| component_diagram | `MermaidDiagram \| None` | No | Component relationship diagram |
| connectivity_diagram | `MermaidDiagram \| None` | No | External connectivity diagram |
| api | `CanonicalAPI \| None` | No | API endpoint analysis |
| build | `CanonicalBuild \| None` | No | Build/CI/CD analysis |
| testing | `CanonicalTesting \| None` | No | Test file analysis |
| logging | `CanonicalLogging \| None` | No | Logging pattern analysis |
| data_flow | `CanonicalDataFlow \| None` | No | Data flow and request path analysis |
