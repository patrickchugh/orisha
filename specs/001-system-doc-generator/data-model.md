# Data Model: Orisha

**Date**: 2026-01-31
**Branch**: `001-system-doc-generator`

## Entity Relationship Overview

```
┌─────────────────┐     ┌─────────────────────┐
│   Repository    │────▶│   AnalysisResult    │
└─────────────────┘     └─────────────────────┘
                                  │
                                  ▼
┌─────────────────┐     ┌─────────────────────┐     ┌─────────────────┐
│ LLMConfiguration│────▶│  OutputDocument     │◀────│ HumanOverrides  │
└─────────────────┘     └─────────────────────┘     └─────────────────┘
                                  ▲
┌─────────────────┐               │
│ DocTemplate     │───────────────┘
└─────────────────┘

┌─────────────────┐     ┌─────────────────────┐
│  ToolRegistry   │────▶│   ToolAdapter       │
└─────────────────┘     └─────────────────────┘
```

---

## Entities

### Repository

The source git repository being analyzed; contains source files, infrastructure code, and dependency manifests.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| path | `Path` | Yes | Absolute path to repository root |
| git_ref | `str \| None` | No | Current git commit SHA or branch name |
| name | `str` | Yes | Repository name (derived from path or git remote) |
| detected_languages | `list[str]` | Yes | Languages detected via file extensions and parsing |

**Validation Rules:**
- `path` must exist and be a directory
- `path` must contain a `.git` directory (warning if not a git repo)
- `detected_languages` populated from file extension scanning

---

### AnalysisResult

Structured data collected from deterministic analysis tools (AST parsing, Syft, dependency parsing); serves as input to template rendering.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| repository | `Repository` | Yes | Source repository reference |
| timestamp | `datetime` | Yes | Analysis execution timestamp (UTC) |
| technology_stack | `TechnologyStack` | Yes | Detected languages, frameworks, dependencies |
| sbom | `SBOM \| None` | No | Syft-generated Software Bill of Materials |
| architecture_diagram | `ArchitectureDiagram \| None` | No | Terravision-generated diagram |
| source_analysis | `SourceAnalysis` | Yes | AST-derived code structure information |
| errors | `list[AnalysisError]` | Yes | Non-fatal errors encountered during analysis |

**State Transitions:**
- `pending` → `running` → `completed` | `failed`

---

### TechnologyStack

Inventory of detected languages, frameworks, and dependencies; derived from dependency files and Syft scanning.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| languages | `list[LanguageInfo]` | Yes | Detected programming languages with versions |
| frameworks | `list[Framework]` | Yes | Detected frameworks (e.g., FastAPI, React) |
| dependencies | `list[Dependency]` | Yes | Third-party dependencies with versions |
| dev_dependencies | `list[Dependency]` | Yes | Development-only dependencies |

**Derived From:**
- `package.json` → JavaScript/TypeScript dependencies
- `requirements.txt` / `pyproject.toml` → Python dependencies
- `go.mod` → Go dependencies
- `pom.xml` / `build.gradle` → Java dependencies

---

### Dependency

A single third-party dependency with version information.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Package name |
| version | `str \| None` | No | Version specifier (may be range or exact) |
| source_file | `str` | Yes | File where dependency was declared |
| ecosystem | `str` | Yes | Package ecosystem (npm, pypi, go, maven) |
| license | `str \| None` | No | License identifier if available from SBOM |

---

### SBOM

Software Bill of Materials generated by Syft.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| format | `str` | Yes | SBOM format (syft-json, cyclonedx, spdx) |
| packages | `list[SBOMPackage]` | Yes | All detected packages |
| source | `str` | Yes | Syft version and scan target |
| generated_at | `datetime` | Yes | SBOM generation timestamp |

---

### ArchitectureDiagram

Visual representation of cloud infrastructure generated from Terraform; embedded as image in final documentation.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| image_path | `Path` | Yes | Path to generated PNG/SVG file |
| format | `str` | Yes | Image format (png, svg) |
| source_files | `list[str]` | Yes | Terraform files used to generate diagram |
| cloud_provider | `str \| None` | No | Detected cloud provider (aws, gcp, azure) |
| generation_tool | `str` | Yes | Tool used (terravision) |

---

### SourceAnalysis

AST-derived information about code structure.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| modules | `list[ModuleInfo]` | Yes | Detected modules/packages |
| entry_points | `list[EntryPoint]` | Yes | Main functions, CLI commands, API endpoints |
| classes | `list[ClassInfo]` | Yes | Class definitions with methods |
| functions | `list[FunctionInfo]` | Yes | Top-level functions |
| parsing_errors | `list[ParsingError]` | Yes | Files that failed to parse |

---

### LLMConfiguration

Settings specifying which LLM backend to use and connection parameters.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| provider | `str` | Yes | LLM provider (claude, gemini, ollama) |
| model | `str` | Yes | Model identifier |
| api_key | `str \| None` | No | API key (not required for Ollama) |
| api_base | `str \| None` | No | API base URL (required for Ollama) |
| temperature | `float` | Yes | Temperature setting (default: 0) |
| max_tokens | `int` | Yes | Maximum response tokens |
| enabled | `bool` | Yes | Whether LLM summarization is enabled |

**Validation Rules:**
- `provider` must be one of: claude, gemini, ollama
- `temperature` must be 0 for reproducibility (FR-012)
- `api_key` required for claude and gemini
- `api_base` required for ollama (defaults to http://localhost:11434)

---

### DocumentationTemplate

A Jinja2 template defining the structure and sections of the output document.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| path | `Path` | Yes | Path to template file |
| name | `str` | Yes | Template identifier |
| format | `str` | Yes | Output format (markdown, html, confluence) |
| placeholders | `list[str]` | Yes | Available placeholder variables |
| custom_sections | `dict[str, str]` | No | User-defined content for specific sections |

**Validation Rules:**
- `path` must exist and be readable
- Template must be valid Jinja2 syntax

---

### OutputDocument

The final rendered documentation in the specified format.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| content | `str` | Yes | Rendered document content |
| format | `str` | Yes | Output format (markdown, html, confluence) |
| generated_at | `datetime` | Yes | Generation timestamp (UTC) |
| version_history | `list[VersionEntry]` | Yes | Document version history (SC-011) |
| source_repository | `str` | Yes | Git remote URL or path |
| source_commit | `str \| None` | No | Git commit SHA at generation time |
| embedded_assets | `list[Path]` | Yes | Paths to embedded images (diagrams) |
| llm_sections | `list[str]` | Yes | Sections generated by LLM |
| deterministic_sections | `list[str]` | Yes | Sections generated deterministically |

---

### VersionEntry

A single entry in the document version history (SC-011).

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| version | `str` | Yes | Version identifier |
| timestamp | `datetime` | Yes | Change timestamp (UTC) |
| author | `str` | Yes | Author: "Orisha" or human name |
| author_type | `str` | Yes | Type: "automated" or "human" |
| changes | `str` | Yes | Summary of changes |
| git_ref | `str \| None` | No | Git commit SHA for this version |

---

### AnalysisError

Non-fatal error encountered during analysis.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| component | `str` | Yes | Component that failed (syft, terravision, ast) |
| message | `str` | Yes | Error description |
| file_path | `str \| None` | No | File that caused the error |
| recoverable | `bool` | Yes | Whether analysis continued |

---

## Canonical Data Formats (Principle V: Tool Agnosticism)

These are the **standard internal formats** that all tool adapters MUST produce. The rest of Orisha only works with these canonical formats, never with tool-specific output. This enables true tool swappability.

### CanonicalSBOM

Standard SBOM format produced by all SBOM tool adapters (Syft, Trivy, etc.).

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| packages | `list[CanonicalPackage]` | Yes | All detected packages |
| source | `SBOMSource` | Yes | Metadata about the scan |

### CanonicalPackage

Standard package representation across all SBOM tools.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Package name |
| version | `str \| None` | No | Version string |
| ecosystem | `str` | Yes | Package ecosystem: `npm`, `pypi`, `go`, `maven`, `cargo`, etc. |
| license | `str \| None` | No | SPDX license identifier |
| source_file | `str \| None` | No | File where dependency was declared |
| purl | `str \| None` | No | Package URL (standardized identifier) |

### SBOMSource

Metadata about the SBOM generation.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| tool | `str` | Yes | Tool that generated this (e.g., "syft", "trivy") |
| tool_version | `str` | Yes | Version of the tool |
| scanned_at | `datetime` | Yes | When the scan was performed |
| target | `str` | Yes | What was scanned (path or image name) |

---

### CanonicalArchitecture

Standard architecture format produced by all diagram/infrastructure tool adapters. Uses a hybrid format: adjacency list for connections (matching Terravision's native output) plus node metadata dict.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| graph | `CanonicalGraph` | Yes | The architecture topology |
| rendered_image | `RenderedImage \| None` | No | Optional pre-rendered PNG/SVG |
| source | `ArchitectureSource` | Yes | Metadata about generation |

### CanonicalGraph

Hybrid graph structure: adjacency list for connections, dict for node metadata.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| nodes | `dict[str, NodeMetadata]` | Yes | Node ID → metadata mapping |
| connections | `dict[str, list[str]]` | Yes | Node ID → list of connected node IDs (adjacency list) |
| cloud_providers | `list[str]` | Yes | Providers present: `aws`, `gcp`, `azure` |

**Example:**
```python
{
    "nodes": {
        "aws_s3_bucket.data": {"type": "aws_s3_bucket", "provider": "aws", "name": "data-bucket"},
        "aws_lambda_function.processor": {"type": "aws_lambda_function", "provider": "aws"}
    },
    "connections": {
        "aws_s3_bucket.data": ["aws_lambda_function.processor"],
        "aws_lambda_function.processor": ["aws_dynamodb_table.results"]
    },
    "cloud_providers": ["aws"]
}
```

### NodeMetadata

Metadata for a single node in the architecture graph.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| type | `str` | Yes | Resource type (e.g., `aws_s3_bucket`, `google_compute_instance`) |
| provider | `str` | Yes | Cloud provider: `aws`, `gcp`, `azure` |
| name | `str \| None` | No | Human-readable name |
| attributes | `dict[str, Any] \| None` | No | Key properties (region, size, etc.) |

### RenderedImage

Optional pre-rendered visualization of the architecture.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| data | `bytes \| None` | No | Embedded image data |
| path | `Path \| None` | No | Path to image file |
| format | `str` | Yes | Image format: `png`, `svg` |

### ArchitectureSource

Metadata about how the architecture was extracted.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| tool | `str` | Yes | Tool that generated this (e.g., "terravision") |
| tool_version | `str` | Yes | Version of the tool |
| generated_at | `datetime` | Yes | When the graph was generated |
| source_files | `list[str]` | Yes | Infrastructure files used (Terraform, CloudFormation, etc.) |
| source_type | `str` | Yes | Source format: `terraform`, `cloudformation`, `pulumi`, `manual` |

---

### CanonicalAST

Standard AST analysis format produced by all AST tool adapters.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| modules | `list[CanonicalModule]` | Yes | Detected modules/packages |
| entry_points | `list[CanonicalEntryPoint]` | Yes | Main functions, CLI commands |
| classes | `list[CanonicalClass]` | Yes | Class definitions |
| functions | `list[CanonicalFunction]` | Yes | Top-level functions |
| source | `ASTSource` | Yes | Metadata about parsing |

### CanonicalModule

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Module/package name |
| path | `str` | Yes | File path |
| language | `str` | Yes | Programming language |
| imports | `list[str]` | Yes | Import statements |

### CanonicalClass

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Class name |
| file | `str` | Yes | File path |
| line | `int` | Yes | Line number |
| methods | `list[str]` | Yes | Method names |
| bases | `list[str]` | Yes | Base classes |

### CanonicalFunction

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Function name |
| file | `str` | Yes | File path |
| line | `int` | Yes | Line number |
| parameters | `list[str]` | Yes | Parameter names |
| is_async | `bool` | Yes | Whether function is async |

### CanonicalEntryPoint

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Entry point name |
| type | `str` | Yes | Type: `main`, `cli_command`, `api_endpoint`, `handler` |
| file | `str` | Yes | File path |
| line | `int` | Yes | Line number |

### ASTSource

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| tool | `str` | Yes | Parser used (e.g., "tree-sitter") |
| languages | `list[str]` | Yes | Languages parsed |
| files_parsed | `int` | Yes | Number of files successfully parsed |
| files_failed | `int` | Yes | Number of files that failed to parse |
| parsed_at | `datetime` | Yes | When parsing was performed |

---

## Tool Adapter Pattern

### ToolAdapter (Principle V: Tool Agnosticism)

Abstract interface for pluggable analysis tools. Each adapter transforms tool-specific output to canonical format.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `str` | Yes | Tool identifier (e.g., "syft", "trivy") |
| capability | `str` | Yes | Capability type (sbom, diagram, ast) |
| version | `str \| None` | No | Tool version if available |

**Interface Methods:**
- `check_available() -> bool` - Verify tool is installed and accessible
- `get_version() -> str | None` - Return tool version string
- `execute(input: Path) -> CanonicalFormat` - Run tool and return **canonical format**

**Adapter Responsibilities:**
1. Invoke the external tool with appropriate arguments
2. Parse tool-specific output (JSON, text, etc.)
3. Transform to canonical format (CanonicalSBOM, CanonicalDiagram, etc.)
4. Handle tool-specific errors gracefully

**Example: Syft Adapter**
```
Syft JSON output → SyftAdapter.execute() → CanonicalSBOM
```

**Example: Trivy Adapter**
```
Trivy JSON output → TrivyAdapter.execute() → CanonicalSBOM (same format!)
```

---

### ToolRegistry (Principle V: Tool Agnosticism)

Registry of available tool adapters for each capability.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| sbom_adapters | `dict[str, SBOMAdapter]` | Yes | Registered SBOM adapters |
| diagram_adapters | `dict[str, DiagramAdapter]` | Yes | Registered diagram adapters |
| ast_adapters | `dict[str, ASTAdapter]` | Yes | Registered AST adapters |

**Configuration:**
```yaml
tools:
  sbom: syft          # → uses SyftAdapter → outputs CanonicalSBOM
  diagrams: terravision  # → uses TerravisionAdapter → outputs CanonicalDiagram
```

**Adding a New Tool:**
1. Implement the appropriate adapter interface (e.g., `SBOMAdapter`)
2. Transform tool output to canonical format
3. Register in ToolRegistry
4. No changes needed to rest of codebase

---

### SectionConfig (Principle VI: Human Annotation Persistence)

Configuration for a human-authored section that merges with generated content.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| section_id | `str` | Yes | Section identifier (e.g., "overview", "security") |
| file | `Path` | Yes | Path to markdown file with human content |
| strategy | `str` | Yes | How to merge: "replace", "prepend", "append" |

**Merge Strategies:**
- `replace`: Human content replaces generated content entirely
- `prepend`: Human content appears before generated content
- `append`: Human content appears after generated content

**Configuration Example:**
```yaml
sections:
  overview:
    file: ".orisha/sections/overview.md"
    strategy: "prepend"
  security:
    file: ".orisha/sections/security.md"
    strategy: "append"
```

**File Structure:**
```
.orisha/
├── config.yaml
└── sections/
    ├── overview.md
    └── security.md
```

---

## Configuration Schema

### OrishaConfig

Top-level configuration loaded from YAML file. CLI provides only per-run overrides (`--output`, `--format`, `--ci`).

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| output | `OutputConfig` | Yes | - | Output path and format |
| template | `TemplateConfig \| None` | No | None | Custom template settings |
| tools | `ToolConfig` | No | defaults | Tool selection (Principle V) |
| sections | `dict[str, SectionConfig]` | No | `{}` | Human content sections (Principle VI) |
| llm | `LLMConfiguration \| None` | No | None | LLM settings |
| ci | `CIConfig` | No | defaults | CI/CD settings |

---

### ToolConfig (Principle V: Tool Agnosticism)

Tool selection configuration. Tools are auto-skipped if not applicable (no dependency files, no Terraform).

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| sbom | `str` | No | `syft` | SBOM tool: syft, trivy |
| diagrams | `str` | No | `terravision` | Diagram tool: terravision |

**Configuration File Locations** (in priority order):
1. CLI `--config` argument
2. `./.orisha/config.yaml`
3. `./orisha.yaml`
