{# SYSTEM.md Template - Orisha System Documentation Generator #}
{# This template produces deterministic output following Principle II #}
# {{ repository_name }} System Documentation

> Auto-generated by [Orisha](https://github.com/your-org/orisha) on {{ timestamp | format_datetime }}
> Git Reference: {{ git_ref | default("N/A", true) }}

---

## Table of Contents

1. [Overview](#overview)
2. [Technology Stack](#technology-stack)
3. [Dependencies](#dependencies)
{% if architecture and architecture.graph.node_count > 0 %}
4. [Architecture](#architecture)
{% endif %}
{% if modules or entry_points or external_integrations or (holistic_overview and holistic_overview.external_integrations) %}
5. [System Flow](#system-flow)
{% endif %}
6. [Version History](#version-history)
7. [Analysis Metadata](#analysis-metadata)

---

## Overview

{% if holistic_overview %}
{{ holistic_overview.to_markdown() | replace_negative_assertions }}

{% endif %}
{% if sections.overview %}
{{ sections.overview }}
{% elif llm_summaries.overview %}
{{ llm_summaries.overview | replace_negative_assertions }}
{% elif not holistic_overview %}
*No overview provided. Add an overview section in `.orisha/sections/overview.md`*
{% endif %}

---

## Technology Stack

{% if llm_summaries.tech_stack and not llm_summaries.tech_stack.startswith("*") %}
{{ llm_summaries.tech_stack | replace_negative_assertions }}

{% endif %}
{% if technology_stack.languages or technology_stack.frameworks %}
| Component | Type | Description | Version |
|-----------|------|-------------|---------|
{% for lang in technology_stack.languages %}
| **{{ lang.name }}** | Language | {% if lang.file_count %}{{ lang.file_count }} source file{% if lang.file_count > 1 %}s{% endif %}{% else %}Primary language{% endif %} | {{ lang.version | default("—", true) }} |
{% endfor %}
{% for fw in technology_stack.frameworks %}
| **{{ fw.name }}** | Framework | {{ fw.language | default("Application", true) }} framework | {{ fw.version | default("—", true) }} |
{% endfor %}
{% else %}
N/A
{% endif %}

---

## Dependencies

{% if sbom %}
| Metric | Value |
|--------|-------|
| **Direct Dependencies** | {{ sbom.direct_package_count }} packages |
| **Total (incl. transitive)** | {{ sbom.package_count }} packages |
| **Ecosystems** | {{ sbom.get_unique_ecosystems() | join(", ") | default("None", true) }} |
| **SBOM Tool** | {{ sbom.source.tool if sbom.source else "Unknown" }} {{ sbom.source.tool_version if sbom.source else "" }} |

{% endif %}
{% if llm_summaries.dependencies and not llm_summaries.dependencies.startswith("*") %}
{{ llm_summaries.dependencies | replace_negative_assertions }}

{% endif %}
### Direct Dependencies

{% if sbom and sbom.get_direct_packages() %}
{% set packages_by_ecosystem = {} %}
{% for pkg in sbom.get_direct_packages() %}
{% if pkg.ecosystem not in packages_by_ecosystem %}
{% set _ = packages_by_ecosystem.update({pkg.ecosystem: []}) %}
{% endif %}
{% set _ = packages_by_ecosystem[pkg.ecosystem].append(pkg) %}
{% endfor %}

{% for ecosystem, packages in packages_by_ecosystem.items() %}
**{{ ecosystem | upper }}** ({{ packages | length }} packages)

| Package | Purpose | Version | License |
|---------|---------|---------|---------|
{% for pkg in packages[:25] %}
| {{ pkg.name }} | {{ pkg.description | default("—", true) | truncate(50, true) }} | {{ pkg.version | default("—", true) }} | {{ pkg.license | default("—", true) }} |
{% endfor %}
{% if packages | length > 25 %}
| *... {{ packages | length - 25 }} more* | | | |
{% endif %}

{% endfor %}
{% elif technology_stack.dependencies %}
| Package | Ecosystem | Version | License |
|---------|-----------|---------|---------|
{% for dep in technology_stack.dependencies[:30] %}
| {{ dep.name }} | {{ dep.ecosystem }} | {{ dep.version | default("—", true) }} | {{ dep.license | default("—", true) }} |
{% endfor %}
{% if technology_stack.dependencies | length > 30 %}

*... and {{ technology_stack.dependencies | length - 30 }} more dependencies.*
{% endif %}
{% else %}
N/A
{% endif %}

{% if technology_stack.dev_dependencies %}
### Development Dependencies

| Package | Purpose | Version |
|---------|---------|---------|
{% for dep in technology_stack.dev_dependencies[:15] %}
| {{ dep.name }} | {{ dep.description | default("Development tooling", true) }} | {{ dep.version | default("—", true) }} |
{% endfor %}
{% if technology_stack.dev_dependencies | length > 15 %}

*... and {{ technology_stack.dev_dependencies | length - 15 }} more dev dependencies.*
{% endif %}
{% endif %}

{% if architecture and architecture.graph.node_count > 0 %}
---

## Architecture

{% if sections.architecture %}
{{ sections.architecture }}

{% elif llm_summaries.architecture and not llm_summaries.architecture.startswith("*") %}
{{ llm_summaries.architecture | replace_negative_assertions }}

{% endif %}
### Cloud Infrastructure

{% if architecture.cloud_providers %}
**Cloud Providers**: {{ architecture.cloud_providers | join(", ") }}
{% else %}
N/A
{% endif %}

{% if architecture.source and architecture.source.metadata and architecture.source.metadata.terraform_variables %}
### Configuration

| Variable | Value |
|----------|-------|
{% for var_name, var_value in architecture.source.metadata.terraform_variables.items() %}
| `{{ var_name }}` | {{ var_value }} |
{% endfor %}
{% endif %}

### Resource Graph

- **Total Resources**: {{ architecture.graph.node_count }}
- **Connections**: {{ architecture.graph.connection_count }}

{% if architecture.graph.node_count > 0 %}
#### Resources by Provider

{% for provider in architecture.cloud_providers %}
**{{ provider | upper }}**

| Resource | Type | Details |
|----------|------|---------|
{% for node_id, node in architecture.graph.nodes.items() %}
{% if node.provider == provider %}
{% set details = [] %}
{% if node.attributes %}
{% if node.attributes.runtime %}{% set _ = details.append("runtime: " ~ node.attributes.runtime) %}{% endif %}
{% if node.attributes.memory_size %}{% set _ = details.append("memory: " ~ node.attributes.memory_size ~ "MB") %}{% endif %}
{% if node.attributes.timeout %}{% set _ = details.append("timeout: " ~ node.attributes.timeout ~ "s") %}{% endif %}
{% if node.attributes.handler %}{% set _ = details.append("handler: " ~ node.attributes.handler) %}{% endif %}
{% if node.attributes.billing_mode %}{% set _ = details.append(node.attributes.billing_mode) %}{% endif %}
{% if node.attributes.hash_key %}{% set _ = details.append("key: " ~ node.attributes.hash_key) %}{% endif %}
{% if node.attributes.retention_in_days %}{% set _ = details.append("retention: " ~ node.attributes.retention_in_days ~ "d") %}{% endif %}
{% if node.attributes.threshold %}{% set _ = details.append("threshold: " ~ node.attributes.threshold) %}{% endif %}
{% if node.attributes.invoke_mode %}{% set _ = details.append(node.attributes.invoke_mode) %}{% endif %}
{% if node.attributes.authorization_type %}{% set _ = details.append("auth: " ~ node.attributes.authorization_type) %}{% endif %}
{% endif %}
| {{ node.name | default(node_id, true) }} | `{{ node.type }}` | {{ details | join(", ") if details else "-" }} |
{% endif %}
{% endfor %}

{% endfor %}
{% endif %}

{% if architecture.rendered_image %}
### Architecture Diagram

![Architecture Diagram](architecture.png)
{% endif %}
{% endif %}

{% if modules or entry_points or external_integrations or (holistic_overview and holistic_overview.external_integrations) %}
---

## System Flow

{% if module_flow_diagram and module_flow_diagram.mermaid %}
### Module Dependencies

The following diagram shows the relationships between modules in this codebase:

```mermaid
{{ module_flow_diagram.mermaid }}
```

{% if module_flow_diagram.simplified %}
> *Note: This diagram has been simplified from {{ module_flow_diagram.node_count }} nodes for readability.*
{% endif %}
{% endif %}

{% if modules %}
### Modules

{% set modules_with_responsibility = modules | selectattr("responsibility") | list %}
{% if modules_with_responsibility %}
| Module | Files | Responsibility |
|--------|-------|----------------|
{% for module in modules_with_responsibility[:30] %}
| `{{ module.name }}` | {{ module.file_count }} | {{ module.responsibility | truncate(80, true) }} |
{% endfor %}
{% if modules_with_responsibility | length > 30 %}

*... and {{ modules_with_responsibility | length - 30 }} more modules.*
{% endif %}
{% else %}
| Module | Files | Key Functions |
|--------|-------|---------------|
{% for module in modules[:30] %}
| `{{ module.name }}` | {{ module.file_count }} | {{ module.key_functions[:3] | join(", ") | default("-", true) }}{% if module.key_functions | length > 3 %}...{% endif %} |
{% endfor %}
{% if modules | length > 30 %}

*... and {{ modules | length - 30 }} more modules.*
{% endif %}
{% endif %}
{% endif %}

{% if entry_points %}
### Entry Points

Entry points are the public interfaces where external systems interact with this codebase:

| Name | Type | File | Description |
|------|------|------|-------------|
{% for ep in entry_points %}
| `{{ ep.name }}` | {{ ep.type }} | {{ ep.file }}:{{ ep.line }} | {{ ep.description | default("-", true) | truncate(60, true) }} |
{% endfor %}
{% endif %}

{# Merge LLM and deterministic integrations for comprehensive coverage #}
{% set llm_integrations = holistic_overview.external_integrations if holistic_overview else [] %}
{% set det_integrations = external_integrations | default([]) %}
{% set has_integrations = (llm_integrations | length > 0) or (det_integrations | length > 0) %}

{% if has_integrations %}
### External Integrations

This system connects to the following external services:

{% if llm_integrations | length > 0 %}
{# LLM-detected integrations have semantic understanding (purpose) #}
| Service | Type | Purpose |
|---------|------|---------|
{% for integration in llm_integrations %}
| {{ integration.name }} | {{ integration.type }} | {{ integration.purpose | default("-", true) | truncate(80, true) }} |
{% endfor %}

{% endif %}
{% if det_integrations | length > 0 %}
{# Deterministic detection catches actual library usage LLM may miss #}
{% set llm_names = llm_integrations | map(attribute='name') | map('lower') | list %}
{% set unique_det = [] %}
{% for det in det_integrations %}
{% if det.name | lower not in llm_names %}
{% set _ = unique_det.append(det) %}
{% endif %}
{% endfor %}
{% if unique_det | length > 0 %}
{% if llm_integrations | length > 0 %}
**Additional detected integrations** (from code analysis):

{% endif %}
| Service | Type | Library | Locations |
|---------|------|---------|-----------|
{% for det in unique_det %}
| {{ det.name }} | {{ det.type }} | {{ det.library }} | {{ det.locations | join(", ") | truncate(60, true) }} |
{% endfor %}
{% endif %}
{% endif %}
{% elif not has_integrations %}
### External Integrations

No external integrations detected.
{% endif %}
{% endif %}

{# Code Structure section removed - holistic overview provides system-wide understanding #}
{# Raw class/function/module counts don't help architects #}

---

## Version History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
{% for entry in version_history[-10:] | reverse %}
| {{ entry.version }} | {{ entry.timestamp | format_datetime }} | {{ entry.author }} ({{ entry.author_type }}) | {{ entry.changes }} |
{% endfor %}

---

## Analysis Metadata

### Tool Versions

| Tool | Version |
|------|---------|
{% for tool, version in tool_versions.items() %}
| {{ tool }} | {{ version }} |
{% endfor %}

### Analysis Status

- **Status**: {{ status }}
- **Timestamp**: {{ timestamp | format_datetime }}
- **Git Reference**: {{ git_ref | default("N/A", true) }}

{% if errors %}
### Analysis Errors

| Component | Error | Recoverable |
|-----------|-------|-------------|
{% for error in errors %}
| {{ error.component }} | {{ error.message }} | {{ "Yes" if error.recoverable else "No" }} |
{% endfor %}
{% endif %}

---

*Generated by Orisha System Documentation Generator*
